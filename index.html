<!DOCTYPE html>
<html lang="en">
<head>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keep the Ball Alive: Roguelite Deluxe</title>
<style>
html, body { margin:0; padding:0; overflow:hidden; font-family:'Segoe UI',sans-serif; background:#111; color:#fff;}
canvas { display:block; background:#222; margin:0 auto; }
#ui { position:absolute; top:10px; left:50%; transform:translateX(-50%); width:90%; text-align:center; pointer-events:none;}
.panel { background: linear-gradient(135deg,#333,#444); border-radius:12px; padding:8px 12px; margin:5px auto; display:flex; justify-content:space-between; align-items:center; width:300px; font-size:16px;}
#overlay, #homeScreen { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:linear-gradient(135deg,#333,#444); border:2px solid #fff; border-radius:12px; padding:20px; text-align:center; width:360px; box-shadow:0 0 12px #000;}
.upgradeBtn, .shopBtn, .startBtn { display:block; margin:10px auto; padding:10px; background:#555; border:2px solid #fff; border-radius:8px; cursor:pointer; font-size:16px; transition:0.2s; width:80%;}
.upgradeBtn:hover, .shopBtn:hover, .startBtn:hover { background:#666; transform:scale(1.05);}
h2 { margin:10px 0;}
#xpBarContainer, #communityXPBarContainer { width:300px; height:20px; background:#555; border-radius:10px; margin:5px auto; overflow:hidden;}
#xpBarFill { height:100%; width:0%; background:#0f0; transition:width 0.2s;}
#communityXPBarFill { height:100%; width:0%; background:#0ff; transition:width 0.2s;}
#floatingXP { position:absolute; pointer-events:none; font-weight:bold; color:#0f0; text-shadow:0 0 4px #0f0;}
</style>
</head>
<body>
<canvas id="game"></canvas>

<div id="ui">
  <div class="panel"><span>Score</span><span id="score">0</span></div>
  <div class="panel"><span>Level</span><span id="levelBar">1</span></div>
  <div id="xpBarContainer"><div id="xpBarFill"></div></div>
  <div class="panel"><span>Lives</span><span id="lives">5 ‚ù§Ô∏è</span></div>
  <div class="panel"><span>Meta XP</span><span id="metaXP">0</span></div>
  <div class="panel"><span>Community Level</span><span id="communityLevel">1</span></div>
  <div id="communityXPBarContainer"><div id="communityXPBarFill"></div></div>
</div>

<div id="homeScreen">
  <h2>Keep the Ball Alive</h2>
  <p>Move the paddle to keep the ball alive.<br>Each bounce gives XP and grows your paddle.<br>After each run, pick an upgrade.<br>Lose all 5 lives and spend Meta XP in the shop.</p>
  <button class="startBtn" id="startBtn">Start Game</button>
</div>

<div id="overlay">
  <h2 id="overlayTitle">Choose an Upgrade</h2>
  <div id="overlayButtons"></div>
  <button id="overlayClose" class="shopBtn" style="display:none;">Continue</button>
</div>

<div id="floatingXP"></div>

<audio id="sfxBounce" src="https://freesound.org/data/previews/26/26435_512123-lq.mp3"></audio>
<audio id="sfxLevel" src="https://freesound.org/data/previews/26/26431_512123-lq.mp3"></audio>
<audio id="sfxLife" src="https://freesound.org/data/previews/26/26429_512123-lq.mp3"></audio>
<audio id="sfxUpgrade" src="https://freesound.org/data/previews/26/26432_512123-lq.mp3"></audio>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
window.addEventListener('resize', ()=>{canvas.width=window.innerWidth; canvas.height=window.innerHeight;});

// üîå Connect to Community XP server (GLOBAL)
const socket = io("https://plip-plop-wxdz.onrender.com");

// DOM
const scoreEl=document.getElementById('score');
const levelEl=document.getElementById('levelBar');
const xpBarFill=document.getElementById('xpBarFill');
const livesEl=document.getElementById('lives');
const metaEl=document.getElementById('metaXP');
const overlay=document.getElementById('overlay');
const overlayTitle=document.getElementById('overlayTitle');
const overlayButtons=document.getElementById('overlayButtons');
const overlayClose=document.getElementById('overlayClose');
const homeScreen=document.getElementById('homeScreen');
const startBtn=document.getElementById('startBtn');
const floatingXP=document.getElementById('floatingXP');
const communityLevelEl=document.getElementById('communityLevel');
const communityXPBarFill=document.getElementById('communityXPBarFill');

// SFX
const sfx = {
  bounce: document.getElementById('sfxBounce'),
  level: document.getElementById('sfxLevel'),
  life: document.getElementById('sfxLife'),
  upgrade: document.getElementById('sfxUpgrade')
}

// Game state
let paddle={x:canvas.width/2-80,y:canvas.height-40,width:160,height:20,speed:10};
let balls=[],particles=[];
let score=0,xp=0,level=1,xpToNext=10;
let metaXP=parseInt(localStorage.getItem('metaXP')||0);
let xpPerBounce=1;
let inRun=false;
let lives=5,difficultyMultiplier=1;

// Community XP (demo via localStorage)
let communityXP = parseInt(localStorage.getItem('communityXP')||0);
let communityLevel = parseInt(localStorage.getItem('communityLevel')||1);
let communityXPToNext = 100;

function updateCommunityXPBar(){
  communityLevelEl.textContent = communityLevel;
  communityXPBarFill.style.width = Math.min(100,(communityXP/communityXPToNext*100))+'%';
}

function addCommunityXP(amount){
  communityXP += amount;
  while(communityXP >= communityXPToNext){
    communityXP -= communityXPToNext;
    communityLevel++;
    communityXPToNext = Math.floor(communityXPToNext*1.2);
  }
  localStorage.setItem('communityXP', communityXP);
  localStorage.setItem('communityLevel', communityLevel);
  updateCommunityXPBar();
}

// Controls
let keys={};
window.addEventListener('keydown', e=>keys[e.key]=true);
window.addEventListener('keyup', e=>keys[e.key]=false);

// Balls
function spawnBall(x,y,dx,dy){
  balls.push({
    x:x||canvas.width/2,
    y:y||canvas.height/2,
    dx:(dx||((Math.random()<0.5?4:-4)))*difficultyMultiplier,
    dy:(dy||-4)*difficultyMultiplier,
    radius:12,
    color:'hsl('+Math.random()*360+',80%,60%)'
  });
}

// Particle effect
function spawnParticles(x,y,color){
  for(let i=0;i<5;i++){
    particles.push({x:x,y:y,dx:(Math.random()-0.5)*4,dy:(Math.random()-1.5)*4,alpha:1,color:color,radius:Math.random()*3+2});
  }
}

// Floating XP
function showFloatingXP(x,y,amount){
  const span=document.createElement('span');
  span.textContent='+'+amount+' XP';
  span.style.position='absolute'; span.style.left=x+'px'; span.style.top=y+'px';
  span.style.color='#0f0'; span.style.fontWeight='bold'; span.style.textShadow='0 0 4px #0f0';
  document.body.appendChild(span);
  let pos=0;
  const anim=setInterval(()=>{
    pos+=1.5;
    span.style.top=(y-pos)+'px';
    span.style.opacity=1-pos/50;
    if(pos>50){ clearInterval(anim); document.body.removeChild(span);}
  },16);
}

// Upgrades
const upgradesPool=[
  {name:"Wider Paddle",apply:()=>paddle.width+=20},
  {name:"Faster Paddle",apply:()=>paddle.speed+=2},
  {name:"+1 XP/Bounce",apply:()=>xpPerBounce++},
  {name:"Second Ball",apply:()=>{
    const offset = balls.length*20;
    const dx = (Math.random()<0.5?4:-4)*difficultyMultiplier;
    balls.push({x:canvas.width/2 + (Math.random()*60-30),y:canvas.height/2 - offset,dx:dx,dy:-4*difficultyMultiplier,radius:12,color:'hsl(' + Math.random()*360 + ',80%,60%)'});
  }},
  {name:"Bigger Ball",apply:()=>balls.forEach(b=>b.radius+=3)},
  {name:"Slower Ball",apply:()=>balls.forEach(b=>{b.dx*=0.8;b.dy*=0.8})},
  {name:"XP Boost",apply:()=>xpPerBounce+=2},
];

// Meta shop
const metaShop=[
  {name:"Permanent Paddle Width +20",cost:10,apply:()=>{paddle.width+=20}},
  {name:"Permanent XP/Bounce +1",cost:15,apply:()=>{xpPerBounce++}},
  {name:"Permanent Paddle Speed +2",cost:20,apply:()=>{paddle.speed+=2}}
];

// Show upgrades
function showUpgradeScreen(){
  inRun=false;
  overlayTitle.textContent="Pick 1 Upgrade (per run)";
  overlayButtons.innerHTML='';
  let choices=[];
  while(choices.length<3){
    let u=upgradesPool[Math.floor(Math.random()*upgradesPool.length)];
    if(!choices.includes(u)) choices.push(u);
  }
  choices.forEach(u=>{
    let btn=document.createElement('button');
    btn.textContent=u.name;
    btn.className='upgradeBtn';
    btn.onclick=()=>{ u.apply(); sfx.upgrade.play(); restartRun(); };
    overlayButtons.appendChild(btn);
  });
  overlayClose.style.display='none';
  overlay.style.display='block';
}

// Show meta shop
function showMetaShop(){
  inRun=false;
  overlayTitle.textContent="Meta Shop (Meta XP: "+metaXP+")";
  overlayButtons.innerHTML='';
  metaShop.forEach(item=>{
    let btn=document.createElement('button');
    btn.textContent=item.name+" (Cost: "+item.cost+")";
    btn.className='shopBtn';
    btn.onclick=()=>{
      if(metaXP>=item.cost){ metaXP-=item.cost; localStorage.setItem('metaXP',metaXP); item.apply(); showMetaShop(); sfx.upgrade.play(); }
      else alert("Not enough Meta XP!");
    };
    overlayButtons.appendChild(btn);
  });
  overlayClose.style.display='block';
  overlay.style.display='block';
}

// Start game
startBtn.onclick=()=>{
  homeScreen.style.display='none';
  startSession();
};

function startSession(){
  lives=5; difficultyMultiplier=1; restartRun();
}

// End run
function endRun(){
  lives--; sfx.life.play();
  difficultyMultiplier*=1.1;
  if(lives<=0){
    metaXP+=Math.floor(score/2); localStorage.setItem('metaXP',metaXP);
    lives=5; difficultyMultiplier=1; balls=[]; spawnBall();
    showMetaShop();
  } else { balls=[]; spawnBall(); showUpgradeScreen(); }
}

// Restart run
function restartRun(){
  score=0; xp=0; level=1; xpToNext=10;
  if(balls.length===0) spawnBall();
  particles=[]; inRun=true; overlay.style.display='none'; gameLoop();
}

// Game loop
function gameLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!inRun) return;

  // Paddle
  if(keys['ArrowLeft']||keys['a']) paddle.x-=paddle.speed;
  if(keys['ArrowRight']||keys['d']) paddle.x+=paddle.speed;
  paddle.x=Math.max(0,Math.min(canvas.width-paddle.width,paddle.x));
  ctx.fillStyle="#fff"; ctx.fillRect(paddle.x,paddle.y,paddle.width,paddle.height);

  // Balls
  balls.forEach((ball,i)=>{
    ball.x+=ball.dx; ball.y+=ball.dy;
    if(ball.x-ball.radius<0||ball.x+ball.radius>canvas.width) {ball.dx*=-1; sfx.bounce.play();}
    if(ball.y-ball.radius<0){ ball.dy*=-1; sfx.bounce.play();}
    if(ball.x+ball.radius>paddle.x && ball.x-ball.radius<paddle.x+paddle.width &&
       ball.y+ball.radius>paddle.y && ball.y-ball.radius<paddle.y+paddle.height){
         ball.dy*=-1; ball.y=paddle.y-ball.radius;
         score++; xp+=xpPerBounce; addCommunityXP(xpPerBounce);
         spawnParticles(ball.x,ball.y,ball.color); showFloatingXP(ball.x,ball.y,xpPerBounce); sfx.bounce.play();
         if(xp>=xpToNext){ xp-=xpToNext; xpToNext=Math.floor(xpToNext*1.3); level++; paddle.width+=5; sfx.level.play();}
    }
    if(ball.y-ball.radius>canvas.height){ endRun(); }
    ctx.fillStyle=ball.color; ctx.beginPath(); ctx.arc(ball.x,ball.y,ball.radius,0,Math.PI*2); ctx.fill();
  });

  // Particles
  particles.forEach((p,i)=>{
    p.x+=p.dx; p.y+=p.dy; p.alpha-=0.02;
    ctx.fillStyle='rgba(255,255,255,'+p.alpha+')';
    ctx.beginPath(); ctx.arc(p.x,p.y,p.radius,0,Math.PI*2); ctx.fill();
    if(p.alpha<=0) particles.splice(i,1);
  });

  // UI
  scoreEl.textContent=""+score;
  levelEl.textContent=""+level;
  xpBarFill.style.width = Math.min(100,(xp/xpToNext*100))+'%';
  livesEl.textContent=lives+' ‚ù§Ô∏è';
  metaEl.textContent=""+metaXP;

  requestAnimationFrame(gameLoop);
}

// Overlay close
overlayClose.onclick=()=>{ overlay.style.display='none'; inRun=true; gameLoop(); };

// Key M for meta shop
window.addEventListener('keydown', e=>{if(e.key==='m'){showMetaShop();}});

// Initialize community bar on load
updateCommunityXPBar();
</script>
</body>
</html>
